name: Send DingTalk Notification

on:
  workflow_dispatch:  # 允许手动触发
  schedule:
    - cron: '50 7 * * *'  # 每天7:50运行

jobs:
  send-notification:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python 3.10
        uses: actions/setup-python@v3
        with:
          python-version: "3.10"
          
      - name: Install dependencies
        run: |
          pip install requests
          
      - name: Send DingTalk Notification
        env:
          DINGTALK_ACCESS_TOKEN: ${{ secrets.DINGTALK_ACCESS_TOKEN }}
          DINGTALK_SECRET: ${{ secrets.DINGTALK_SECRET }}
        run: |
          python -c "import os,json,requests,hmac,hashlib,base64,urllib.parse,datetime;def send_to_dingtalk(content):access_token=os.getenv('DINGTALK_ACCESS_TOKEN');secret=os.getenv('DINGTALK_SECRET');timestamp=str(round(datetime.datetime.now().timestamp()*1000));string_to_sign=f'{timestamp}\n{secret}';hmac_code=hmac.new(secret.encode(),string_to_sign.encode(),digestmod=hashlib.sha256).digest();sign=urllib.parse.quote_plus(base64.b64encode(hmac_code));webhook=f'https://oapi.dingtalk.com/robot/send?access_token={access_token}&timestamp={timestamp}&sign={sign}';message={'msgtype':'markdown','markdown':{'title':'📢 微信公众号安全漏洞文章每日更新','text':content}};response=requests.post(webhook,json=message);print('钉钉通知发送成功' if response.status_code==200 else f'钉钉通知发送失败: {response.text}');def get_today_updates():f=open('README.md','r',encoding='utf-8');content=f.read();f.close();today=datetime.datetime.now().strftime('%Y-%m-%d');start_marker=f'### 📅 {today}';end_marker='### 📅';start_idx=content.find(start_marker);end_idx=content.find(end_marker,start_idx+len(start_marker)) if start_idx!=-1 else -1;today_content=content[start_idx:] if end_idx==-1 else content[start_idx:end_idx];lines=today_content.split('\n');formatted_content=['## 📢 今日更新提醒\n'];for line in lines:formatted_content.append('\n### 📚 新增文章\n' if line.startswith('#### 📚 新增文章') else '\n### 📊 统计信息\n' if line.startswith('#### 📊 统计信息') else f'> 🔹 {line}' if line.strip().startswith(('1.', '2.', '3.', '4.', '5.', '6.', '7.', '8.', '9.')) else f'> 📎 {line}' if line.strip().startswith('- 原文链接') or line.strip().startswith('- GitHub备份') else f'> 📈 {line[1:].strip()}' if line.startswith('- 新增文章数') else f'> ⏰ {line[1:].strip()}' if line.startswith('- 更新时间') else '');formatted_content.append('\n---\n> 💡 更多详情请访问GitHub仓库');return '\n'.join(formatted_content) if start_idx!=-1 else '## 📢 今日更新提醒\n\n> 今日暂无新文章更新';send_to_dingtalk(get_today_updates())" 
