name: Send DingTalk Notification

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_run:
    workflows: ["update today"]
    types:
      - completed
    branches:
      - main

jobs:
  send-notification:
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python 3.10
        uses: actions/setup-python@v3
        with:
          python-version: "3.10"
          
      - name: Install dependencies
        run: |
          pip install requests pytz
          
      - name: Create Python script
        run: |
          echo "import os" > send_notification.py
          echo "import json" >> send_notification.py
          echo "import requests" >> send_notification.py
          echo "import hmac" >> send_notification.py
          echo "import hashlib" >> send_notification.py
          echo "import base64" >> send_notification.py
          echo "import urllib.parse" >> send_notification.py
          echo "import datetime" >> send_notification.py
          echo "import re" >> send_notification.py
          echo "import pytz" >> send_notification.py
          echo "" >> send_notification.py
          echo "def get_beijing_time():" >> send_notification.py
          echo "    beijing_tz = pytz.timezone('Asia/Shanghai')" >> send_notification.py
          echo "    return datetime.datetime.now(beijing_tz)" >> send_notification.py
          echo "" >> send_notification.py
          echo "def send_to_dingtalk(content):" >> send_notification.py
          echo "    access_token = os.getenv('DINGTALK_ACCESS_TOKEN')" >> send_notification.py
          echo "    secret = os.getenv('DINGTALK_SECRET')" >> send_notification.py
          echo "    timestamp = str(round(datetime.datetime.now().timestamp() * 1000))" >> send_notification.py
          echo "    string_to_sign = f'{timestamp}\\n{secret}'" >> send_notification.py
          echo "    hmac_code = hmac.new(secret.encode(), string_to_sign.encode(), digestmod=hashlib.sha256).digest()" >> send_notification.py
          echo "    sign = urllib.parse.quote_plus(base64.b64encode(hmac_code))" >> send_notification.py
          echo "    webhook = f'https://oapi.dingtalk.com/robot/send?access_token={access_token}&timestamp={timestamp}&sign={sign}'" >> send_notification.py
          echo "    message = {" >> send_notification.py
          echo "        'msgtype': 'markdown'," >> send_notification.py
          echo "        'markdown': {" >> send_notification.py
          echo "            'title': 'ğŸ“¢ å¾®ä¿¡å…¬ä¼—å·å®‰å…¨æ¼æ´æ–‡ç« æ¯æ—¥æ›´æ–°'," >> send_notification.py
          echo "            'text': content" >> send_notification.py
          echo "        }" >> send_notification.py
          echo "    }" >> send_notification.py
          echo "    response = requests.post(webhook, json=message)" >> send_notification.py
          echo "    if response.status_code == 200:" >> send_notification.py
          echo "        result = response.json()" >> send_notification.py
          echo "        if result.get('errcode') == 0:" >> send_notification.py
          echo "            print('é’‰é’‰é€šçŸ¥å‘é€æˆåŠŸ')" >> send_notification.py
          echo "        else:" >> send_notification.py
          echo "            print(f'é’‰é’‰é€šçŸ¥å‘é€å¤±è´¥: {result}')" >> send_notification.py
          echo "    else:" >> send_notification.py
          echo "        print(f'é’‰é’‰é€šçŸ¥å‘é€å¤±è´¥: {response.text}')" >> send_notification.py
          echo "" >> send_notification.py
          echo "def get_today_updates():" >> send_notification.py
          echo "    with open('README.md', 'r', encoding='utf-8') as f:" >> send_notification.py
          echo "        content = f.read()" >> send_notification.py
          echo "    today = get_beijing_time().strftime('%Y-%m-%d')" >> send_notification.py
          echo "    print(f'å½“å‰æ—¥æœŸ: {today}')" >> send_notification.py
          echo "    start_marker = f'## ğŸ“¢ {today}æ—¥æ–°å¢æ–‡ç« '" >> send_notification.py
          echo "    print(f'æŸ¥æ‰¾æ ‡è®°: {start_marker}')" >> send_notification.py
          echo "    end_marker = '## ğŸ“Š ç»Ÿè®¡ä¿¡æ¯'" >> send_notification.py
          echo "    # æ‰¾åˆ°æ‰€æœ‰å½“å¤©çš„åŒºå—" >> send_notification.py
          echo "    blocks = []" >> send_notification.py
          echo "    start_idx = 0" >> send_notification.py
          echo "    while True:" >> send_notification.py
          echo "        start_idx = content.find(start_marker, start_idx)" >> send_notification.py
          echo "        print(f'æ‰¾åˆ°åŒºå—ä½ç½®: {start_idx}')" >> send_notification.py
          echo "        if start_idx == -1:" >> send_notification.py
          echo "            break" >> send_notification.py
          echo "        end_idx = content.find(end_marker, start_idx)" >> send_notification.py
          echo "        if end_idx == -1:" >> send_notification.py
          echo "            end_idx = len(content)" >> send_notification.py
          echo "        block = content[start_idx:end_idx].strip()" >> send_notification.py
          echo "        print(f'æ‰¾åˆ°åŒºå—å†…å®¹:\\n{block}')" >> send_notification.py
          echo "        blocks.append(block)" >> send_notification.py
          echo "        start_idx = end_idx" >> send_notification.py
          echo "    if not blocks:" >> send_notification.py
          echo "        print('æ²¡æœ‰æ‰¾åˆ°ä»»ä½•åŒºå—')" >> send_notification.py
          echo "        return f'## ğŸ“¢ {today}æ—¥æ–°å¢æ–‡ç« \\n\\n> ä»Šæ—¥æš‚æ— æ–°æ–‡ç« æ›´æ–°'" >> send_notification.py
          echo "    # åªå–æœ€æ–°çš„åŒºå—" >> send_notification.py
          echo "    latest_block = blocks[-1]" >> send_notification.py
          echo "    print(f'æœ€æ–°åŒºå—å†…å®¹:\\n{latest_block}')" >> send_notification.py
          echo "    # æ·»åŠ ç»Ÿè®¡ä¿¡æ¯å’Œé“¾æ¥" >> send_notification.py
          echo "    footer = f'\\n\\n---\\nğŸš€ [githubä»“åº“](https://github.com/zxarj/wxvl)\\n<font size=2>ğŸ“Š ç»Ÿè®¡ä¿¡æ¯\\nğŸ“ æ–°å¢æ–‡ç« æ•°ï¼š{len(blocks)}ç¯‡ â° æ›´æ–°æ—¶é—´ï¼š{get_beijing_time().strftime(\"%Y-%m-%d %H:%M\")}</font>'" >> send_notification.py
          echo "    # æ ¼å¼åŒ–æ–‡ç« åˆ—è¡¨" >> send_notification.py
          echo "    articles = []" >> send_notification.py
          echo "    # åªå¤„ç†æœ€æ–°åŒºå—ä¸­çš„æ–‡ç« " >> send_notification.py
          echo "    lines = latest_block.split('\\n')" >> send_notification.py
          echo "    for line in lines:" >> send_notification.py
          echo "        if line.strip().startswith('1.') or line.strip().startswith('2.') or line.strip().startswith('3.') or line.strip().startswith('4.') or line.strip().startswith('5.'):" >> send_notification.py
          echo "            articles.append(line.strip())" >> send_notification.py
          echo "    # é‡æ–°æ ¼å¼åŒ–æ–‡ç« åˆ—è¡¨ï¼Œä¿æŒæ•°å­—ç¼–å·" >> send_notification.py
          echo "    formatted_articles = '\\n'.join(articles)" >> send_notification.py
          echo "    return f'## ğŸ“¢ {today}æ—¥æ–°å¢æ–‡ç« \\n\\n{formatted_articles}{footer}'" >> send_notification.py
          echo "" >> send_notification.py
          echo "if __name__ == '__main__':" >> send_notification.py
          echo "    current_time = get_beijing_time().strftime('%H:%M')" >> send_notification.py
          echo "    content = get_today_updates()" >> send_notification.py
          echo "    if 'ä»Šæ—¥æš‚æ— æ–°æ–‡ç« æ›´æ–°' not in content:" >> send_notification.py
          echo "        send_to_dingtalk(content)" >> send_notification.py
          echo "    else:" >> send_notification.py
          echo "        print('æ²¡æœ‰æ–°æ–‡ç« ï¼Œè·³è¿‡æ¨é€')" >> send_notification.py
          
      - name: Send DingTalk Notification
        env:
          DINGTALK_ACCESS_TOKEN: ${{ secrets.DINGTALK_ACCESS_TOKEN }}
          DINGTALK_SECRET: ${{ secrets.DINGTALK_SECRET }}
        run: |
          python send_notification.py 
