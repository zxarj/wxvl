name: Send DingTalk Notification

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '50 7 * * *'  # æ¯å¤©7:50è¿è¡Œ

jobs:
  send-notification:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python 3.10
        uses: actions/setup-python@v3
        with:
          python-version: "3.10"
          
      - name: Install dependencies
        run: |
          pip install requests
          
      - name: Create Python script
        run: |
          cat > send_notification.py << 'EOL'
import os
import json
import requests
import hmac
import hashlib
import base64
import urllib.parse
import datetime

def send_to_dingtalk(content):
    access_token = os.getenv("DINGTALK_ACCESS_TOKEN")
    secret = os.getenv("DINGTALK_SECRET")
    timestamp = str(round(datetime.datetime.now().timestamp() * 1000))
    string_to_sign = f"{timestamp}\n{secret}"
    hmac_code = hmac.new(secret.encode(), string_to_sign.encode(), digestmod=hashlib.sha256).digest()
    sign = urllib.parse.quote_plus(base64.b64encode(hmac_code))
    webhook = f"https://oapi.dingtalk.com/robot/send?access_token={access_token}&timestamp={timestamp}&sign={sign}"
    message = {
        "msgtype": "markdown",
        "markdown": {
            "title": "ðŸ“¢ å¾®ä¿¡å…¬ä¼—å·å®‰å…¨æ¼æ´žæ–‡ç« æ¯æ—¥æ›´æ–°",
            "text": content
        }
    }
    response = requests.post(webhook, json=message)
    print("é’‰é’‰é€šçŸ¥å‘é€æˆåŠŸ" if response.status_code == 200 else f"é’‰é’‰é€šçŸ¥å‘é€å¤±è´¥: {response.text}")

def get_today_updates():
    with open("README.md", "r", encoding="utf-8") as f:
        content = f.read()
    
    today = datetime.datetime.now().strftime("%Y-%m-%d")
    start_marker = f"### ðŸ“… {today}"
    end_marker = "### ðŸ“…"
    
    start_idx = content.find(start_marker)
    if start_idx == -1:
        return "## ðŸ“¢ ä»Šæ—¥æ›´æ–°æé†’\n\n> ä»Šæ—¥æš‚æ— æ–°æ–‡ç« æ›´æ–°"
    
    end_idx = content.find(end_marker, start_idx + len(start_marker))
    today_content = content[start_idx:] if end_idx == -1 else content[start_idx:end_idx]
    
    lines = today_content.split("\n")
    formatted_content = ["## ðŸ“¢ ä»Šæ—¥æ›´æ–°æé†’\n"]
    
    for line in lines:
        if line.startswith("#### ðŸ“š æ–°å¢žæ–‡ç« "):
            formatted_content.append("\n### ðŸ“š æ–°å¢žæ–‡ç« \n")
        elif line.startswith("#### ðŸ“Š ç»Ÿè®¡ä¿¡æ¯"):
            formatted_content.append("\n### ðŸ“Š ç»Ÿè®¡ä¿¡æ¯\n")
        elif line.strip().startswith(("1.", "2.", "3.", "4.", "5.", "6.", "7.", "8.", "9.")):
            formatted_content.append(f"> ðŸ”¹ {line}")
        elif line.strip().startswith("- åŽŸæ–‡é“¾æŽ¥") or line.strip().startswith("- GitHubå¤‡ä»½"):
            formatted_content.append(f"> ðŸ“Ž {line}")
        elif line.startswith("- æ–°å¢žæ–‡ç« æ•°"):
            formatted_content.append(f"> ðŸ“ˆ {line[1:].strip()}")
        elif line.startswith("- æ›´æ–°æ—¶é—´"):
            formatted_content.append(f"> â° {line[1:].strip()}")
    
    formatted_content.append("\n---\n> ðŸ’¡ æ›´å¤šè¯¦æƒ…è¯·è®¿é—®GitHubä»“åº“")
    return "\n".join(formatted_content)

if __name__ == "__main__":
    send_to_dingtalk(get_today_updates())
EOL
          
      - name: Send DingTalk Notification
        env:
          DINGTALK_ACCESS_TOKEN: ${{ secrets.DINGTALK_ACCESS_TOKEN }}
          DINGTALK_SECRET: ${{ secrets.DINGTALK_SECRET }}
        run: |
          python send_notification.py 
