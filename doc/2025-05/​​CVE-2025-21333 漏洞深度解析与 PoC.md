#  ​​CVE-2025-21333 漏洞深度解析与 PoC   
云梦DC  云梦安全   2025-05-29 01:00  
  
一、漏洞核心原理  
  
漏洞位置与成因  
  
CVE-2025-21333 是 Windows Hyper-V NT 内核集成组件中的提权漏洞，位于驱动文件 vkrnlintvsp.sys 的 VkiRootAdjustSecurityDescriptorForVmwp 函数中。该函数在调整虚拟机的安全描述符时，因 整数溢出 错误导致堆缓冲区溢出：  
  
计算缺陷：分配内存时，Dacl->AclSize（用户可控）与固定偏移相加后未校验溢出，导致 ExAllocatePool2 分配的内存小于实际需求。  
  
内存破坏：memmove 操作时，数据超出分配范围，覆盖相邻堆块的控制结构，引发代码执行或系统崩溃。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/ndxZsFvkmpy6D2vRcMEuia8qiaIicTF15wg2JhtSR03v5b4sKrOG7vz4xlWqYq7xiaDrmVS8LNMHzVuuDoMXQvuibaQ/640?wx_fmt=png&from=appmsg "")  
  
  
触发条件  
  
需启用 Windows 沙箱功能（验证攻击者为合法虚拟机操作）。  
  
攻击者需构造包含畸形 DACL 的 安全描述符，并通过 NtCreateCrossVmEvent 系统调用触发漏洞。  
  
二、漏洞利用技术  
  
利用链设计  
  
堆风水（Heap Feng Shui）：  
  
使用 WNF 状态数据对象（Pool Tag WnfS）填充分页池，制造可控的内存空洞。  
  
溢出后重新分配 _IOP_MC_BUFFER_ENTRY 指针数组（Pool Tag IrRB），覆盖其指向用户态伪造的 IOP_MC_BUFFER_ENTRY 结构。  
  
任意地址读写：  
  
通过 BuildIoRingWriteFile 和 BuildIoRingReadFile，利用伪造的 IOP_MC_BUFFER_ENTRY 结构实现内核任意读写。  
  
权限提升关键步骤  
  
令牌替换：读取系统进程 EPROCESS 结构中的 Token 字段，替换当前进程令牌为 SYSTEM。  
  
进程劫持：通过 NtQuerySystemInformation 获取关键内核对象地址，绕过 ASLR 保护。  
```
// 伪代码示例：令牌替换
EPROCESS *system_proc = find_eproc("System");
TOKEN system_token = system_proc->Token;
EPROCESS *curr_proc = get_current_eproc();
curr_proc->Token = system_token;  // 提权至 SYSTEM
```  
  
三、影响范围与修复方案  
  
受影响系统  
  
Windows 客户端：Windows 10 21H2 ~ Windows 11 24H2。  
  
服务器版本：Windows Server 2012 R2 ~ 2025（含 Server Core）。  
  
官方修复措施  
  
补丁更新：安装 2025 年 1 月累积更新（KB5050021），添加整数溢出检查。  
  
代码修正：  
```
// 修复后代码片段
if (new_size < original_size) {  // 新增溢出校验
    return STATUS_INTEGER_OVERFLOW;
}
ExAllocatePool2(...);
```  
  
  
临时缓解建议  
  
禁用 Windows 沙箱功能（非必需场景）。  
  
通过组策略限制 NtCreateCrossVmEvent 调用。  
  
四、漏洞利用限制与挑战  
  
利用稳定性问题  
  
内存布局不可控：溢出长度（最大 0xFFF0 字节）不完全可控，可能导致崩溃。  
  
竞争条件：堆喷射后，其他驱动可能占用目标内存区域，需多次尝试。  
  
现代内核防护机制  
  
池隔离（Pool Isolation）：不同驱动分配的内存池分离，限制跨池溢出。  
  
SMAP/SMEP：阻止用户态代码直接执行，需结合 ROP 链绕过。  
  
五、时间线与关联漏洞  
  
2025-01-05：漏洞初次披露。  
  
2025-01-14：微软发布补丁。  
  
2025-02-01：野外利用样本确认。  
  
关联漏洞：  
  
CVE-2021-31956：类似 WNF 利用技术。  
  
CVE-2022-21882：内核池溢出利用案例。  
  
六、防御建议与检测方案  
  
行为监控  
  
可疑 API 调用：高频 NtCreateWnfStateName 和 NtUpdateWnfStateData（堆喷射特征）。  
  
异常进程令牌突变：非父进程来源的令牌变更触发告警。  
  
内存特征检测  
  
分页池标签交替：ViRo（虚拟化驱动）与 WnfS（WNF 对象）交替出现。  
  
异常 ACL 结构：AclSize ≥ 0xFFB0 的异常安全描述符。  
  
poc：  
  
https://github.com/MrAle98/CVE-2025-21333-POC  
  
  
总结  
  
CVE-2025-21333 展示了 内核堆溢出漏洞 在复杂内存管理机制下的利用可能性。攻击者通过 WNF 堆喷射 和 I/O 环形缓冲区劫持 实现高权限代码执行，凸显了现代内核漏洞利用的技术深度。企业需结合 补丁管理、行为分析 与 内存监控 构建纵深防御体系。  
  
